<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SKZ Schedule</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
// SupabaseåˆæœŸåŒ–ï¼ˆCDNèª­ã¿è¾¼ã¿ç›´å¾Œã«å®Ÿè¡Œï¼‰
const SUPABASE_URL = 'https://nbduyknklcwqbinvhoih.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iZHV5a25rbGN3cWJpbnZob2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjMzNjUsImV4cCI6MjA4NzIzOTM2NX0.kzZYqBwfc8vpGszN2W3so2jURsZXlrve4KvUydYKIfA';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    /* === SKZ THEME (æ°´è‰²Ã—ã‚°ãƒ¬ãƒ¼) === */
    --theme-primary:    #0EA5E9;
    --theme-soft:       #38BDF8;
    --theme-pale:       #BAE6FD;
    --theme-ultra:      #F0F9FF;
    --theme-grad-start: #374151;
    --theme-grad-mid:   #4B5563;
    --theme-grad-end:   #0EA5E9;

    --gray-dark: #2E2E2E;
    --gray-mid: #7A7A7A;
    --gray-light: #CCCCCC;
    --gray-pale: #F4F4F4;
    --white: #FFFFFF;

    /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ï¼šè‰²ç›¸ã‚’å‡ç­‰ã«åˆ†æ•£ã—ã¦è¦‹åˆ†ã‘ã‚„ã™ã */
    --cat-live:    #E8365D;   /* èµ¤ãƒ”ãƒ³ã‚¯ */
    --cat-release: #7C3AED;   /* ç´« */
    --cat-media:   #0EA5E9;   /* æ°´è‰² */
    --cat-goods:   #D97706;   /* ç¥ç€ */
    --cat-apply:   #059669;   /* ç·‘ */
    --cat-penmet:  #DB2777;   /* ãƒã‚¼ãƒ³ã‚¿ */
    --cat-birthday:#F97316;   /* ã‚ªãƒ¬ãƒ³ã‚¸ */
    --cat-anniv:   #0D9488;   /* ãƒ†ã‚£ãƒ¼ãƒ« */
    --cat-other:   #6B7280;   /* ã‚°ãƒ¬ãƒ¼ */
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--gray-pale); color:var(--gray-dark); }

  /* ===== LAYOUT ===== */
  html, body { height:100%; }
  .widget { display:grid; grid-template-rows:auto 1fr; height:100vh; }

  .main { display:grid; grid-template-columns:320px 1fr; height:calc(100vh - 64px); overflow:hidden; }

  /* ===== HEADER ===== */
  .header {
    background: linear-gradient(135deg, var(--theme-grad-start) 0%, var(--theme-grad-mid) 70%, var(--theme-grad-end) 100%);
    padding:14px 24px;
    display:flex; align-items:center; justify-content:space-between;
    height:64px;
    position:relative; overflow:hidden;
  }
  .header::before {
    content:''; position:absolute; top:-20px; right:40px;
    width:90px; height:90px; border-radius:50%;
    background:rgba(255,255,255,0.1);
  }
  .header-title {
    font-family:'Nunito',sans-serif; font-size:20px; font-weight:900;
    color:white; display:flex; align-items:center; gap:8px;
  }
  .header-sub { font-size:11px; color:rgba(255,255,255,0.8); margin-top:1px; }
  .add-btn {
    background:rgba(255,255,255,0.25); border:1.5px solid rgba(255,255,255,0.55);
    color:white; font-family:'Nunito',sans-serif; font-weight:800; font-size:12px;
    padding:6px 14px; border-radius:20px; cursor:pointer;
    backdrop-filter:blur(4px); transition:all .2s; z-index:1;
  }
  .add-btn:hover { background:rgba(255,255,255,0.38); transform:translateY(-1px); }

  /* ===== CALENDAR ===== */
  .cal-panel {
    background:var(--white);
    border-right:1.5px solid var(--theme-pale);
    padding:18px 16px;
    display:flex; flex-direction:column; gap:14px;
    overflow-y:auto;
  }

  .cal-nav { display:flex; align-items:center; justify-content:space-between; gap:4px; }
  .cal-btn {
    background:var(--theme-pale); border:none; color:var(--theme-primary);
    width:28px; height:28px; border-radius:50%; font-size:15px;
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition:all .2s; flex-shrink:0;
  }
  .cal-btn:hover { background:var(--theme-soft); }
  .cal-month { font-family:'Nunito',sans-serif; font-size:15px; font-weight:800; }
  .today-btn {
    background:var(--theme-ultra); border:1.5px solid var(--theme-pale);
    color:var(--theme-primary); font-family:'Nunito',sans-serif; font-weight:800;
    font-size:10px; padding:3px 8px; border-radius:20px;
    cursor:pointer; transition:all .2s; white-space:nowrap;
  }
  .today-btn:hover { background:var(--theme-pale); }

  /* ===== COUNTDOWN ===== */
  .countdown-section { display:flex; flex-direction:column; gap:5px; }
  .countdown-title {
    font-family:'Nunito',sans-serif; font-size:10px; font-weight:800;
    text-transform:uppercase; letter-spacing:1.2px; color:var(--gray-mid);
    margin-bottom:2px;
  }
  .countdown-item {
    background:var(--theme-ultra); border:1.5px solid var(--theme-pale);
    border-radius:10px; padding:7px 9px;
    display:flex; align-items:center; gap:8px;
    cursor:pointer; transition:all .15s;
  }
  .countdown-item:hover { background:var(--theme-pale); }
  .countdown-days-block {
    min-width:46px; text-align:center;
    background:var(--theme-primary);
    border-radius:8px; padding:5px 4px;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    flex-shrink:0;
  }
  .countdown-days {
    font-family:'Nunito',sans-serif; font-size:22px; font-weight:900;
    color:white; line-height:1;
  }
  .countdown-days-unit { font-size:8px; font-weight:800; color:rgba(255,255,255,.75); display:block; text-align:center; letter-spacing:.5px; }
  .countdown-info { flex:1; min-width:0; }
  .countdown-name { font-family:'Nunito',sans-serif; font-size:11px; font-weight:800; color:var(--gray-dark); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .countdown-date { font-size:9px; color:var(--gray-mid); margin-top:1px; }
  .countdown-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }

  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
  .cal-dow {
    text-align:center; font-size:9px; font-weight:700;
    color:var(--gray-mid); padding:3px 0;
    text-transform:uppercase; letter-spacing:.5px;
  }
  .cal-day {
    aspect-ratio:1; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    border-radius:8px; font-size:12px; font-weight:600;
    cursor:pointer; position:relative; transition:all .15s; gap:1px;
    padding:2px;
  }
  .cal-day:hover:not(.empty) { background:var(--theme-ultra); }
  .cal-day.empty { cursor:default; }
  .cal-day.today { background:var(--theme-primary); color:white; }
  .cal-day.selected { background:var(--theme-pale); color:var(--theme-primary); }
  .cal-day.today.selected { background:var(--theme-primary); color:white; }

  /* birthday/anniv highlight ring */
  .cal-day.has-special { position:relative; }
  .cal-day.has-special .day-num { 
    background:var(--theme-ultra);
    border-radius:50%; width:22px; height:22px;
    display:flex; align-items:center; justify-content:center;
    font-size:11px;
  }
  .cal-day.today .day-num { background:transparent !important; }

  .dot-row { display:flex; gap:2px; justify-content:center; flex-wrap:wrap; }
  .dot { width:4px; height:4px; border-radius:50%; }
  .cal-day.today .dot { background:rgba(255,255,255,.8) !important; }

  /* task badge on calendar */
  .task-badge {
    position:absolute; top:1px; right:1px;
    background:#EF4444; color:white;
    font-size:8px; font-weight:800;
    width:13px; height:13px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    line-height:1;
  }
  .task-badge.done { background:#10B981; }

  /* special emoji on cal */
  .special-emoji { font-size:9px; line-height:1; }

  /* legend */
  .legend { display:flex; flex-wrap:wrap; gap:5px; }
  .legend-item { display:flex; align-items:center; gap:3px; font-size:9px; color:var(--gray-mid); font-weight:600; }
  .legend-dot { width:6px; height:6px; border-radius:50%; }

  /* ===== RIGHT PANEL ===== */
  .right-panel {
    display:grid; grid-template-rows:1fr auto;
    overflow:hidden;
  }

  .list-panel {
    padding:18px 20px;
    overflow-y:auto;
    display:flex; flex-direction:column; gap:16px;
  }

  .section-label {
    font-family:'Nunito',sans-serif; font-size:10px; font-weight:800;
    text-transform:uppercase; letter-spacing:1.5px;
    color:var(--gray-mid); margin-bottom:6px;
  }

  /* event card */
  .event-card {
    background:var(--white); border-radius:14px;
    padding:0; border:1.5px solid transparent;
    transition:all .2s; cursor:pointer; overflow:hidden;
  }
  .event-card:hover { border-color:var(--theme-pale); box-shadow:0 4px 14px rgba(255,107,157,.1); }
  .event-card.active { border-color:var(--theme-soft); box-shadow:0 4px 14px rgba(255,107,157,.15); }

  .event-card-top {
    display:flex; gap:12px; align-items:flex-start;
    padding:12px 14px;
    border-left:4px solid transparent;
    position:relative;
  }
  .event-card.live .event-card-top { border-left-color:var(--cat-live); }
  .event-card.release .event-card-top { border-left-color:var(--cat-release); }
  .event-card.media .event-card-top { border-left-color:var(--cat-media); }
  .event-card.goods .event-card-top { border-left-color:var(--cat-goods); }
  .event-card.apply .event-card-top { border-left-color:var(--cat-apply); }
  .event-card.penmet .event-card-top { border-left-color:var(--cat-penmet); }
  .event-card.other .event-card-top { border-left-color:var(--cat-other); }

  .event-date-block { min-width:40px; text-align:center; }
  .event-day-num { font-family:'Nunito',sans-serif; font-size:22px; font-weight:900; line-height:1; }
  .event-day-dow { font-size:9px; font-weight:700; color:var(--gray-mid); text-transform:uppercase; }

  .event-info { flex:1; min-width:0; }
  .event-name { font-family:'Nunito',sans-serif; font-size:13px; font-weight:800; margin-bottom:4px; }
  .event-meta { display:flex; flex-wrap:wrap; gap:5px; align-items:center; }

  .tag {
    font-size:9px; font-weight:700; padding:2px 7px; border-radius:20px;
    display:flex; align-items:center; gap:2px;
  }
  .tag.live { background:#FFE0EC; color:var(--cat-live); }
  .tag.release { background:#F3E8FF; color:var(--cat-release); }
  .tag.media { background:#DBEAFE; color:var(--cat-media); }
  .tag.goods { background:#FEF3C7; color:var(--cat-goods); }
  .tag.apply { background:#FEE2E2; color:var(--cat-apply); }
  .tag.penmet { background:#FCE7F3; color:var(--cat-penmet); }
  .tag.other { background:#F3F4F6; color:var(--cat-other); }

  .countdown-chip {
    background:var(--theme-pale); color:var(--theme-primary);
    font-family:'Nunito',sans-serif; font-size:10px; font-weight:800;
    padding:2px 8px; border-radius:20px;
  }
  .deadline-red { background:#FEF2F2; color:#EF4444; border:1px solid #FEE2E2; font-size:9px; font-weight:800; padding:2px 7px; border-radius:20px; }
  .deadline-warn { background:#FFFBEB; color:#F59E0B; border:1px solid #FDE68A; font-size:9px; font-weight:800; padding:2px 7px; border-radius:20px; }

  /* task summary on card */
  .task-summary {
    display:flex; align-items:center; gap:4px;
    font-size:10px; font-weight:700;
  }
  .task-summary.all-done { color:#10B981; }
  .task-summary.has-remaining { color:#EF4444; }
  .task-summary.no-tasks { color:var(--gray-light); }

  /* task section inside card */
  .task-section {
    border-top:1px solid var(--theme-pale);
    padding:10px 14px;
    display:none;
  }
  .task-section.open { display:block; }

  .task-header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:8px;
  }
  .task-header-label { font-size:10px; font-weight:700; color:var(--gray-mid); text-transform:uppercase; letter-spacing:.8px; }

  .task-list { display:flex; flex-direction:column; gap:5px; margin-bottom:8px; }
  .task-item {
    display:flex; align-items:center; gap:8px;
    padding:6px 8px; border-radius:8px;
    background:var(--gray-pale); transition:background .15s;
  }
  .task-item:hover { background:var(--theme-ultra); }
  .task-check {
    width:16px; height:16px; border-radius:5px;
    border:2px solid var(--gray-light);
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink:0; transition:all .15s;
    background:white;
  }
  .task-check.checked { background:var(--theme-primary); border-color:var(--theme-primary); }
  .task-check.checked::after { content:'âœ“'; color:white; font-size:10px; font-weight:800; }
  .task-text { font-size:12px; font-weight:500; flex:1; }
  .task-item.done .task-text { text-decoration:line-through; color:var(--gray-light); }
  .task-del {
    background:none; border:none; color:var(--gray-light);
    font-size:14px; cursor:pointer; padding:0 2px;
    line-height:1; transition:color .15s;
  }
  .task-del:hover { color:#EF4444; }

  .task-add-row { display:flex; gap:6px; }
  .task-presets { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:6px; }
  .task-preset {
    font-size:10px; padding:3px 9px; border-radius:20px;
    background:var(--theme-pale); color:var(--theme-primary);
    font-weight:700; cursor:pointer; border:none;
    transition:all .15s;
  }
  .task-preset:hover { background:var(--theme-soft); }
  .task-input {
    flex:1; border:1.5px solid var(--gray-light); border-radius:8px;
    padding:5px 10px; font-family:'DM Sans',sans-serif; font-size:12px;
    outline:none; transition:border-color .2s;
  }
  .task-input:focus { border-color:var(--theme-primary); }
  .task-add-btn {
    background:var(--theme-primary); border:none; color:white;
    font-family:'Nunito',sans-serif; font-weight:800; font-size:12px;
    padding:5px 12px; border-radius:8px; cursor:pointer;
    transition:all .2s;
  }
  .task-add-btn:hover { background:var(--theme-primary); }

  /* special day cards (birthday/anniv) */
  .special-card {
    background:linear-gradient(135deg,#FFF5F9,#FFE8F4);
    border:1.5px solid var(--theme-pale);
    border-radius:14px; padding:10px 14px;
    display:flex; align-items:center; gap:10px;
  }
  .special-card .s-emoji { font-size:24px; }
  .special-card .s-name { font-family:'Nunito',sans-serif; font-size:13px; font-weight:800; }
  .special-card .s-sub { font-size:10px; color:var(--gray-mid); margin-top:2px; }

  /* empty state */
  .empty-state { text-align:center; padding:30px; color:var(--gray-light); }
  .empty-state .e-emoji { font-size:32px; margin-bottom:8px; }
  .empty-state p { font-size:12px; }

  /* ===== MODAL ===== */
  .overlay {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,.35); backdrop-filter:blur(3px);
    z-index:200; align-items:center; justify-content:center;
  }
  .overlay.open { display:flex; }
  .modal {
    background:white; border-radius:20px; padding:24px;
    width:420px; max-width:95vw; max-height:90vh; overflow-y:auto;
    box-shadow:0 20px 60px rgba(255,107,157,.2);
    animation:mIn .25s ease;
  }
  @keyframes mIn { from{transform:scale(.92) translateY(8px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
  .modal-title { font-family:'Nunito',sans-serif; font-size:17px; font-weight:900; margin-bottom:18px; }
  .fg { margin-bottom:12px; }
  .fl { font-size:10px; font-weight:700; color:var(--gray-mid); text-transform:uppercase; letter-spacing:.8px; display:block; margin-bottom:4px; }
  .fi {
    width:100%; border:1.5px solid var(--gray-light); border-radius:9px;
    padding:8px 11px; font-family:'DM Sans',sans-serif; font-size:13px;
    color:var(--gray-dark); outline:none; transition:border-color .2s;
  }
  .fi:focus { border-color:var(--theme-primary); }
  .frow { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

  .cat-grid { display:flex; flex-wrap:wrap; gap:6px; }
  .cat-opt {
    padding:4px 10px; border-radius:20px; font-size:10px; font-weight:700;
    cursor:pointer; border:1.5px solid transparent; opacity:.55; transition:all .15s;
  }
  .cat-opt.sel { opacity:1; border-color:currentColor; }
  .cat-opt.live { background:#FFE0EC; color:var(--cat-live); }
  .cat-opt.release { background:#F3E8FF; color:var(--cat-release); }
  .cat-opt.media { background:#DBEAFE; color:var(--cat-media); }
  .cat-opt.goods { background:#FEF3C7; color:var(--cat-goods); }
  .cat-opt.apply { background:#FEE2E2; color:var(--cat-apply); }
  .cat-opt.penmet { background:#FCE7F3; color:var(--cat-penmet); }
  .cat-opt.other { background:#F3F4F6; color:var(--cat-other); }

  .m-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:16px; }
  .btn-cancel { background:var(--gray-pale); border:none; color:var(--gray-mid); font-family:'Nunito',sans-serif; font-weight:700; font-size:12px; padding:8px 16px; border-radius:9px; cursor:pointer; }
  .btn-save { background:var(--theme-primary); border:none; color:white; font-family:'Nunito',sans-serif; font-weight:800; font-size:12px; padding:8px 20px; border-radius:9px; cursor:pointer; transition:all .2s; }
  .btn-save:hover { background:var(--theme-primary); transform:translateY(-1px); }

  /* ===== ã‚¤ãƒ™ãƒ³ãƒˆæ“ä½œãƒœã‚¿ãƒ³ ===== */
  .event-actions {
    display:flex; gap:5px; margin-left:auto; flex-shrink:0;
  }
  .ev-btn {
    background:none; border:1.5px solid var(--gray-light);
    border-radius:8px; padding:3px 8px; font-size:10px; font-weight:700;
    cursor:pointer; transition:all .15s; color:var(--gray-mid);
    display:flex; align-items:center; gap:3px;
  }
  .ev-btn.edit:hover { border-color:var(--theme-primary); color:var(--theme-primary); background:var(--theme-ultra); }
  .ev-btn.del:hover { border-color:#EF4444; color:#EF4444; background:#FEF2F2; }

  /* ===== ã‚¹ãƒãƒ›å¯¾å¿œ ===== */
  @media (max-width: 680px) {
    .header { padding:10px 14px; height:auto; flex-wrap:wrap; gap:8px; }
    .header-title { font-size:16px; }
    .header-sub { display:none; }
    .theme-btn { font-size:9px; padding:3px 7px; }
    .add-btn { font-size:11px; padding:5px 11px; }

    .main { grid-template-columns:1fr; grid-template-rows:auto 1fr; height:auto; overflow:visible; }

    .cal-panel {
      border-right:none; border-bottom:1.5px solid var(--theme-pale);
      padding:12px; gap:10px;
    }
    .cal-day { font-size:11px; }

    .countdown-section { display:none; } /* ã‚¹ãƒãƒ›ã§ã¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éè¡¨ç¤ºï¼ˆå³ãƒ‘ãƒãƒ«ã«é›†ç´„ï¼‰ */

    .right-panel { grid-template-rows:1fr; height:auto; }
    .list-panel { padding:12px 14px; }

    .widget { height:auto; }
    html, body { height:auto; overflow:auto; }

    /* ã‚¹ãƒãƒ›ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– */
    .mobile-tabs {
      display:flex; background:white;
      border-bottom:1.5px solid var(--theme-pale);
      position:sticky; top:0; z-index:10;
    }
    .mobile-tab {
      flex:1; padding:10px; text-align:center;
      font-family:'Nunito',sans-serif; font-size:11px; font-weight:800;
      color:var(--gray-mid); border:none; background:none; cursor:pointer;
      border-bottom:2.5px solid transparent; transition:all .2s;
    }
    .mobile-tab.active { color:var(--theme-primary); border-bottom-color:var(--theme-primary); }

    .main.show-list .cal-panel { display:none; }
    .main.show-cal .right-panel { display:none; }
  }

  @media (min-width: 681px) {
    .mobile-tabs { display:none; }
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ¼ */
  #loading-bar {
    display:none; position:fixed; top:0; left:0; right:0;
    height:3px; background:linear-gradient(90deg, var(--theme-primary), var(--theme-soft));
    z-index:999; animation:loadingSlide 1.2s ease-in-out infinite;
  }
  @keyframes loadingSlide {
    0% { transform:translateX(-100%); }
    100% { transform:translateX(100%); }
  }

  /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
  .toast {
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#2E2E2E; color:white;
    font-family:'Nunito',sans-serif; font-size:13px; font-weight:700;
    padding:10px 20px; border-radius:20px;
    opacity:0; transition:opacity .3s;
    z-index:999; pointer-events:none; white-space:nowrap;
    box-shadow:0 4px 16px rgba(0,0,0,.2);
  }
  .toast.error { background:#EF4444; }
</style>
</head>
<body>
<div id="loading-bar"></div>
<div id="toast" class="toast"></div>
<div class="widget">
  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="header-title">ğŸ§­ SKZ Schedule</div>
      <div class="header-sub">Stray Kids ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼†ã‚¿ã‚¹ã‚¯ç®¡ç†</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;z-index:1">
      <!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ -->
      <button class="add-btn" id="btn-add-event">ï¼‹ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ </button>
    </div>
  </div>

  <!-- ã‚¹ãƒãƒ›ç”¨ã‚¿ãƒ–åˆ‡æ›¿ -->
  <div class="mobile-tabs">
    <button class="mobile-tab active" id="tab-cal">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
    <button class="mobile-tab" id="tab-list">ğŸ“‹ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
  </div>

  <div class="main show-cal" id="main-grid">
    <!-- CALENDAR -->
    <div class="cal-panel">
      <div class="cal-nav">
        <button class="cal-btn" id="btn-prev-month">â€¹</button>
        <div class="cal-month" id="cal-month"></div>
        <button class="cal-btn" id="btn-next-month">â€º</button>
        <button class="today-btn" id="btn-today">ä»Šæ—¥</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-live)"></div>ãƒ©ã‚¤ãƒ–</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-release)"></div>ãƒªãƒªãƒ¼ã‚¹</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-media)"></div>é…ä¿¡/ãƒ¡ãƒ‡ã‚£ã‚¢</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-goods)"></div>ã‚°ãƒƒã‚º</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-apply)"></div>ç”³è¾¼/æ‰‹é…</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-penmet)"></div>ãƒšãƒ³ãƒŸ</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cat-birthday)"></div>èª•ç”Ÿæ—¥/è¨˜å¿µæ—¥</div>
      </div>
      <!-- COUNTDOWN -->
      <div class="countdown-section">
        <div class="countdown-title">â³ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</div>
        <div id="countdown-list"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="list-panel" id="list-panel"></div>
    </div>
  </div>
</div>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="overlay" id="confirm-overlay">
  <div class="modal" style="max-width:320px;text-align:center">
    <div style="font-size:32px;margin-bottom:12px">ğŸ—‘</div>
    <div style="font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;margin-bottom:6px">ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ</div>
    <div style="font-size:12px;color:var(--gray-mid);margin-bottom:20px">ã€Œ<span id="confirm-name"></span>ã€ã‚’å‰Šé™¤ã™ã‚‹ã‚ˆã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ãªã„ã‚ˆï¼</div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn-cancel" id="btn-confirm-cancel">ã‚„ã£ã±ã‚„ã‚ã‚‹</button>
      <button id="btn-confirm-delete" style="background:#EF4444;border:none;color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;padding:8px 20px;border-radius:9px;cursor:pointer;">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-title" id="modal-title">ğŸ§­ ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </div>
    <input type="hidden" id="f-edit-id" value="">
    <div class="fg">
      <label class="fl">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
      <input class="fi" id="f-name" type="text" placeholder="ä¾‹: MANIAC WORLD TOUR TOKYO">
    </div>
    <div class="fg">
      <label class="fl">ã‚«ãƒ†ã‚´ãƒª</label>
      <div class="cat-grid">
        <div class="cat-opt live" data-cat="live">ğŸ¤ ãƒ©ã‚¤ãƒ–</div>
        <div class="cat-opt release" data-cat="release">ğŸ’¿ ãƒªãƒªãƒ¼ã‚¹</div>
        <div class="cat-opt media" data-cat="media">ğŸ“º é…ä¿¡/ãƒ¡ãƒ‡ã‚£ã‚¢</div>
        <div class="cat-opt goods" data-cat="goods">ğŸ› ã‚°ãƒƒã‚º</div>
        <div class="cat-opt apply" data-cat="apply">ğŸ« ç”³è¾¼/æ‰‹é…</div>
        <div class="cat-opt penmet" data-cat="penmet">ğŸ’Œ ãƒšãƒ³ãƒŸ</div>
        <div class="cat-opt other" data-cat="other">âœ¨ ãã®ä»–</div>
      </div>
    </div>
    <div class="frow">
      <div class="fg"><label class="fl">é–‹å§‹æ—¥</label><input class="fi" id="f-start" type="date"></div>
      <div class="fg"><label class="fl">çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="f-end" type="date"></div>
    </div>
    <div class="frow">
      <div class="fg"><label class="fl">æ™‚é–“ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="f-time" type="time"></div>
      <div class="fg"><label class="fl">å ´æ‰€ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="f-place" type="text" placeholder="ä¾‹: æ±äº¬ãƒ‰ãƒ¼ãƒ "></div>
    </div>
    <div class="fg"><label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="f-memo" type="text" placeholder="ä¾‹: ãƒã‚±ãƒƒãƒˆå½“é¸ï¼"></div>
    <div class="m-actions">
      <button class="btn-cancel" id="btn-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" id="btn-save-label">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
// ===== FIXED SPECIAL DAYS =====
// æ¯å¹´ç¹°ã‚Šè¿”ã—
const SPECIALS = [
  // ãƒ¡ãƒ³ãƒãƒ¼èª•ç”Ÿæ—¥
  { month:10, day:3,  label:'ãƒãƒ³ãƒãƒ£ãƒ³ğŸº ğŸ‚', sub:'1997.10.03', type:'birthday' },
  { month:10, day:23, label:'ãƒªãƒğŸ° ğŸ‚',       sub:'1998.10.23', type:'birthday' },
  { month:8,  day:17, label:'ãƒãƒ£ãƒ³ãƒ“ãƒ³ğŸ–ğŸ‡ ğŸ‚',sub:'1999.08.17', type:'birthday' },
  { month:3,  day:20, label:'ãƒ’ãƒ§ãƒ³ã‚¸ãƒ³ğŸ¥Ÿ ğŸ‚', sub:'2000.03.20', type:'birthday' },
  { month:9,  day:14, label:'ãƒãƒ³ğŸ¿ ğŸ‚',       sub:'2000.09.14', type:'birthday' },
  { month:9,  day:15, label:'ãƒ•ã‚£ãƒªãƒƒã‚¯ã‚¹ğŸ¥ ğŸ‚',sub:'2000.09.15', type:'birthday' },
  { month:9,  day:22, label:'ã‚¹ãƒ³ãƒŸãƒ³ğŸ¶ ğŸ‚',   sub:'2000.09.22', type:'birthday' },
  { month:2,  day:8,  label:'ã‚¢ã‚¤ã‚¨ãƒ³ğŸ¦Š ğŸ‚',   sub:'2001.02.08', type:'birthday' },
  // è¨˜å¿µæ—¥
  { month:3,  day:25, label:'Stray Kids ãƒ‡ãƒ“ãƒ¥ãƒ¼è¨˜å¿µæ—¥ ğŸŠ', sub:'2018.03.25', type:'anniv' },
  { month:8,  day:1,  label:'STAY èª•ç”Ÿæ—¥ ğŸ’š', sub:'2018.08.01', type:'anniv' },
];

function getSpecialsForDate(month1, day) {
  return SPECIALS.filter(s => s.month === month1 && s.day === day);
}

// ===== EVENTSï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ =====
let events = [];

// ===== STATE =====
let currentDate = new Date();
let selectedDate = null;
let activeEventId = null;
let isLoading = false;

const TASK_PRESETS = ['ãƒã‚±ãƒƒãƒˆç”³è¾¼','ãƒã‚±ãƒƒãƒˆè³¼å…¥','äº¤é€šæ‰‹é…','ãƒ›ãƒ†ãƒ«æ‰‹é…','ã‚°ãƒƒã‚ºãƒã‚§ãƒƒã‚¯','äºˆç®—ç¢ºèª','è³¼å…¥','æŒã¡ç‰©æº–å‚™'];
const DAYS = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
const CAT_LABELS = { live:'ğŸ¤ ãƒ©ã‚¤ãƒ–', release:'ğŸ’¿ ãƒªãƒªãƒ¼ã‚¹', media:'ğŸ“º é…ä¿¡/ãƒ¡ãƒ‡ã‚£ã‚¢', goods:'ğŸ› ã‚°ãƒƒã‚º', apply:'ğŸ« ç”³è¾¼/æ‰‹é…', penmet:'ğŸ’Œ ãƒšãƒ³ãƒŸ', other:'âœ¨ ãã®ä»–' };

// ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
async function loadData() {
  setLoading(true);
  try {
    // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
    const { data: evData, error: evErr } = await db
      .from('skz_events')
      .select('*')
      .order('start_date', { ascending: true });
    if (evErr) throw evErr;

    // ã‚¿ã‚¹ã‚¯å–å¾—
    const { data: taskData, error: taskErr } = await db
      .from('skz_tasks')
      .select('*')
      .order('created_at', { ascending: true });
    if (taskErr) throw taskErr;

    // ã‚¿ã‚¹ã‚¯ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã«ç´ã¥ã‘ã¦eventsã«æ ¼ç´
    events = (evData || []).map(ev => ({
      id: ev.id,
      name: ev.name,
      cat: ev.cat,
      start: new Date(ev.start_date + 'T00:00:00'),
      end: ev.end_date ? new Date(ev.end_date + 'T00:00:00') : null,
      time: ev.time,
      place: ev.place,
      memo: ev.memo || '',
      tasks: (taskData || [])
        .filter(t => t.event_id === ev.id)
        .map(t => ({ id: t.id, text: t.text, done: t.done })),
    }));
  } catch(e) {
    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢', 'error');
  }
  setLoading(false);
  renderCalendar(); renderList(); renderCountdown();
}

function setLoading(flag) {
  isLoading = flag;
  const el = document.getElementById('loading-bar');
  if (el) el.style.display = flag ? 'block' : 'none';
}

function showToast(msg, type='success') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = msg;
  toast.className = 'toast ' + type;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 2800);
}

// ===== CALENDAR =====
function renderCalendar() {
  const cy = currentDate.getFullYear();
  const cm = currentDate.getMonth();
  document.getElementById('cal-month').textContent = `${cy}å¹´${cm+1}æœˆ`;

  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-dow'; el.textContent = d;
    grid.appendChild(el);
  });

  const firstDay = new Date(cy, cm, 1).getDay();
  const daysInMonth = new Date(cy, cm+1, 0).getDate();
  const today = new Date();

  for (let i = 0; i < firstDay; i++) {
    const el = document.createElement('div'); el.className = 'cal-day empty';
    grid.appendChild(el);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(cy, cm, d);
    const dayEvs = getEventsForDate(date);
    const specials = getSpecialsForDate(cm+1, d);
    const isToday = today.getFullYear()===cy && today.getMonth()===cm && today.getDate()===d;
    const isSel = selectedDate && selectedDate.getFullYear()===cy && selectedDate.getMonth()===cm && selectedDate.getDate()===d;

    const el = document.createElement('div');
    let cls = 'cal-day';
    if (isToday) cls += ' today';
    if (isSel) cls += ' selected';
    if (dayEvs.length || specials.length) cls += ' has-event';
    if (specials.length) cls += ' has-special';
    el.className = cls;

    const num = document.createElement('div');
    num.className = 'day-num'; num.textContent = d;
    el.appendChild(num);

    // dotsï¼ˆãƒ‰ãƒƒãƒˆï¼‹ç‰¹åˆ¥æ—¥çµµæ–‡å­—ï¼‰
    const dotsRow = document.createElement('div');
    dotsRow.className = 'dot-row';
    [...new Set(dayEvs.map(e=>e.cat))].slice(0,3).forEach(cat => {
      const dot = document.createElement('div');
      dot.className = `dot ${cat}`; dotsRow.appendChild(dot);
    });
    if (specials.length) {
      const dot = document.createElement('div');
      dot.className = 'dot'; dot.style.background = 'var(--cat-birthday)';
      dotsRow.appendChild(dot);
    }
    if (dotsRow.children.length > 0) el.appendChild(dotsRow);

    // ç‰¹åˆ¥æ—¥ã§é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯çµµæ–‡å­—è¡¨ç¤º
    if (specials.length > 0 && dayEvs.length === 0) {
      const sp = document.createElement('div');
      sp.className = 'special-emoji';
      sp.textContent = specials[0].type==='birthday' ? 'ğŸ‚' : 'ğŸŠ';
      el.appendChild(sp);
    }

    // ã‚¿ã‚¹ã‚¯ãƒãƒƒã‚¸ï¼ˆãã®æ—¥ãŒé–‹å§‹æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å¯¾è±¡ã«ã™ã‚‹ï¼‰
    const evStartingToday = events.filter(e => {
      const s = new Date(e.start);
      return s.getFullYear()===cy && s.getMonth()===cm && s.getDate()===d;
    }).filter(e => e.tasks && e.tasks.length > 0);

    if (evStartingToday.length > 0) {
      const remaining = evStartingToday.reduce((a,e) => a + e.tasks.filter(t=>!t.done).length, 0);
      const badge = document.createElement('div');
      badge.className = 'task-badge' + (remaining===0 ? ' done' : '');
      badge.textContent = remaining===0 ? 'âœ“' : remaining;
      el.appendChild(badge);
    }

    el.onclick = () => { selectedDate = date; renderCalendar(); renderList(); };
    grid.appendChild(el);
  }
}

function getEventsForDate(date) {
  return events.filter(e => {
    const s = new Date(e.start); s.setHours(0,0,0,0);
    const end = e.end ? new Date(e.end) : new Date(e.start); end.setHours(23,59,59,999);
    const d = new Date(date); d.setHours(12,0,0,0);
    return d >= s && d <= end;
  });
}

function changeMonth(dir) {
  currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth()+dir, 1);
  renderCalendar(); renderList();
}

function goToday() {
  currentDate = new Date();
  selectedDate = new Date();
  renderCalendar(); renderList();
}

// ===== COUNTDOWN =====
function renderCountdown() {
  const container = document.getElementById('countdown-list');
  if (!container) return;
  container.innerHTML = '';

  const today = new Date(); today.setHours(0,0,0,0);

  const upcoming = events
    .filter(e => { const s = new Date(e.start); s.setHours(0,0,0,0); return s >= today; })
    .sort((a,b) => new Date(a.start) - new Date(b.start))
    .slice(0, 5);

  if (upcoming.length === 0) {
    container.innerHTML = `<div style="font-size:10px;color:var(--gray-light);text-align:center;padding:8px">äºˆå®šãŒãªã„ã‚ˆï¼</div>`;
    return;
  }

  upcoming.forEach(ev => {
    const start = new Date(ev.start); start.setHours(0,0,0,0);
    const diff = Math.ceil((start - today) / 86400000);
    const catColors = { live:'var(--cat-live)', release:'var(--cat-release)', media:'var(--cat-media)', goods:'var(--cat-goods)', apply:'var(--cat-apply)', penmet:'var(--cat-penmet)', other:'var(--cat-other)' };

    const item = document.createElement('div');
    item.className = 'countdown-item';
    item.innerHTML = `
      <div class="countdown-days-block">
        <div class="countdown-days">${diff === 0 ? 'ğŸ‰' : diff}</div>
        <div class="countdown-days-unit">${diff === 0 ? 'TODAY' : 'æ—¥å¾Œ'}</div>
      </div>
      <div class="countdown-dot" style="background:${catColors[ev.cat]||'var(--cat-other)'}"></div>
      <div class="countdown-info">
        <div class="countdown-name">${ev.name}</div>
        <div class="countdown-date">${start.getMonth()+1}/${start.getDate()}ï¼ˆ${DAYS[start.getDay()]}ï¼‰${ev.place ? ' Â· '+ev.place : ''}</div>
      </div>
    `;
    item.onclick = () => {
      selectedDate = new Date(ev.start);
      currentDate = new Date(ev.start.getFullYear(), ev.start.getMonth(), 1);
      renderCalendar(); renderList();
    };
    container.appendChild(item);
  });
}

// ===== LIST =====
function renderList() {
  const panel = document.getElementById('list-panel');
  panel.innerHTML = '';
  const today = new Date(); today.setHours(0,0,0,0);

  // é¸æŠæ—¥
  if (selectedDate) {
    const sd = selectedDate;
    const dayEvs = getEventsForDate(sd);
    const specials = getSpecialsForDate(sd.getMonth()+1, sd.getDate());

    const lbl = document.createElement('div');
    lbl.className = 'section-label';
    lbl.textContent = `${sd.getMonth()+1}æœˆ${sd.getDate()}æ—¥ï¼ˆ${DAYS[sd.getDay()]}ï¼‰`;
    panel.appendChild(lbl);

    specials.forEach(s => panel.appendChild(makeSpecialCard(s)));
    if (dayEvs.length===0 && specials.length===0) panel.appendChild(emptyState('ã“ã®æ—¥ã®äºˆå®šã¯ãªã—'));
    dayEvs.forEach(e => panel.appendChild(makeEventCard(e)));

    const div = document.createElement('div');
    div.style.cssText = 'border-top:1px solid var(--theme-pale);margin:4px 0';
    panel.appendChild(div);
  }

  // ä»Šå¾Œã®äºˆå®š
  const upcoming = events
    .filter(e => { const s=new Date(e.start); s.setHours(0,0,0,0); return s>=today; })
    .sort((a,b)=>new Date(a.start)-new Date(b.start));

  const lbl2 = document.createElement('div');
  lbl2.className = 'section-label'; lbl2.textContent = 'ä»Šå¾Œã®äºˆå®š';
  panel.appendChild(lbl2);

  if (upcoming.length===0) panel.appendChild(emptyState('ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ã‚ˆã†ï¼'));
  else upcoming.slice(0,10).forEach(e => panel.appendChild(makeEventCard(e)));
}

function makeSpecialCard(s) {
  const card = document.createElement('div');
  card.className = 'special-card';
  card.innerHTML = `
    <div class="s-emoji">${s.type==='birthday'?'ğŸ‚':'ğŸŠ'}</div>
    <div><div class="s-name">${s.label}</div><div class="s-sub">${s.sub}</div></div>
  `;
  return card;
}

function makeEventCard(ev) {
  const card = document.createElement('div');
  card.className = `event-card ${ev.cat}${activeEventId===ev.id?' active':''}`;
  card.id = `card-${ev.id}`;

  const start = new Date(ev.start);
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((new Date(ev.start).setHours(0,0,0,0) - today) / 86400000);

  const tasks = ev.tasks || [];
  const done = tasks.filter(t=>t.done).length;
  const remaining = tasks.length - done;

  let taskSummaryHTML = '';
  if (tasks.length===0) {
    taskSummaryHTML = `<span class="task-summary no-tasks js-toggle-tasks">ï¼‹ ã‚¿ã‚¹ã‚¯è¿½åŠ </span>`;
  } else if (remaining===0) {
    taskSummaryHTML = `<span class="task-summary all-done js-toggle-tasks">âœ“ ã™ã¹ã¦å®Œäº†ï¼</span>`;
  } else {
    taskSummaryHTML = `<span class="task-summary has-remaining js-toggle-tasks">âš  æ®‹${remaining}ä»¶</span>`;
  }

  card.innerHTML = `
    <div class="event-card-top js-toggle-tasks">
      <div class="event-date-block">
        <div class="event-day-num">${start.getDate()}</div>
        <div class="event-day-dow">${start.getMonth()+1}æœˆ ${DAYS[start.getDay()]}</div>
      </div>
      <div class="event-info">
        <div class="event-name">${ev.name}</div>
        <div class="event-meta">
          <span class="tag ${ev.cat}">${CAT_LABELS[ev.cat]||ev.cat}</span>
          ${ev.time?`<span style="font-size:10px;color:var(--gray-mid)">ğŸ• ${ev.time}</span>`:''}
          ${ev.place?`<span style="font-size:10px;color:var(--gray-mid)">ğŸ“ ${ev.place}</span>`:''}
          ${diff===0?'<span class="countdown-chip">TODAY ğŸ‰</span>':diff>0&&diff<=30?`<span class="countdown-chip">ã‚ã¨${diff}æ—¥</span>`:''}
          ${ev.cat==='goods'&&ev.end?deadlineBadge(ev.end):''}
          ${taskSummaryHTML}
        </div>
        ${ev.memo?`<div style="font-size:10px;color:var(--gray-mid);margin-top:3px">ğŸ’¬ ${ev.memo}</div>`:''}
      </div>
      <div class="event-actions">
        <button class="ev-btn edit js-edit-event">âœï¸ ç·¨é›†</button>
        <button class="ev-btn del js-delete-event">ğŸ—‘</button>
      </div>
    </div>
    <div class="task-section${activeEventId===ev.id?' open':''}" id="tasks-${ev.id}">
      <div class="task-header">
        <div class="task-header-label">ğŸ“‹ ã‚¿ã‚¹ã‚¯</div>
      </div>
      <div class="task-presets" id="presets-${ev.id}">
        ${TASK_PRESETS.map(p=>`<button class="task-preset js-add-preset" data-text="${p}">${p}</button>`).join('')}
      </div>
      <div class="task-list" id="tasklist-${ev.id}">
      </div>
      <div class="task-add-row">
        <input class="task-input js-task-input" type="text" placeholder="ã‚¿ã‚¹ã‚¯ã‚’è‡ªç”±å…¥åŠ›â€¦">
        <button class="task-add-btn js-add-free-task">è¿½åŠ </button>
      </div>
    </div>
  `;

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’JSå´ã§ä»˜ã‘ã‚‹
  const eid = ev.id;
  card.querySelectorAll('.js-toggle-tasks').forEach(el => {
    el.addEventListener('click', e => { e.stopPropagation(); toggleTasks(e, eid); });
  });
  card.querySelector('.event-actions').addEventListener('click', e => e.stopPropagation());
  card.querySelector('.js-edit-event').addEventListener('click', () => openEditModal(eid));
  card.querySelector('.js-delete-event').addEventListener('click', () => deleteEvent(eid));
  card.querySelectorAll('.js-add-preset').forEach(btn => {
    btn.addEventListener('click', e => { e.stopPropagation(); addPreset(e, eid, btn.dataset.text); });
  });
  const taskInput = card.querySelector('.js-task-input');
  taskInput.addEventListener('keydown', e => { if(e.key==='Enter') addFreeTask(eid, taskInput); });
  card.querySelector('.js-add-free-task').addEventListener('click', () => addFreeTask(eid, taskInput));

  // ã‚¿ã‚¹ã‚¯ã‚’DOMã§è¿½åŠ ï¼ˆãƒªã‚¹ãƒŠãƒ¼ä»˜ãï¼‰
  const taskList = card.querySelector(`#tasklist-${ev.id}`);
  tasks.forEach(t => taskList.appendChild(makeTaskItem(eid, t)));

  return card;
}

function makeTaskItem(eid, t) {
  const div = document.createElement('div');
  div.className = `task-item${t.done?' done':''}`;
  div.id = `ti-${t.id}`;
  div.innerHTML = `
    <div class="task-check${t.done?' checked':''}"></div>
    <div class="task-text">${t.text}</div>
    <button class="task-del">Ã—</button>
  `;
  div.querySelector('.task-check').addEventListener('click', () => toggleTask(eid, t.id));
  div.querySelector('.task-del').addEventListener('click', () => delTask(eid, t.id));
  return div;
}

function toggleTasks(e, eid) {
  e.stopPropagation();
  activeEventId = activeEventId===eid ? null : eid;
  renderList();
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒƒã‚¸ã‚‚æ›´æ–°
  renderCalendar();
}

async function toggleTask(eid, tid) {
  const ev = events.find(e=>e.id===eid);
  if (!ev) return;
  const t = ev.tasks.find(t=>t.id===tid);
  if (!t) return;
  const newDone = !t.done;
  try {
    const { error } = await db.from('skz_tasks').update({ done: newDone }).eq('id', tid);
    if (error) throw error;
    t.done = newDone;
    renderList(); renderCalendar();
  } catch(e) { console.error(e); showToast('æ›´æ–°ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢','error'); }
}

async function delTask(eid, tid) {
  try {
    const { error } = await db.from('skz_tasks').delete().eq('id', tid);
    if (error) throw error;
    const ev = events.find(e=>e.id===eid);
    if (ev) ev.tasks = ev.tasks.filter(t=>t.id!==tid);
    renderList(); renderCalendar();
  } catch(e) { console.error(e); showToast('å‰Šé™¤ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢','error'); }
}

async function addPreset(e, eid, text) {
  e.stopPropagation();
  const ev = events.find(e=>e.id===eid);
  if (!ev || ev.tasks.some(t=>t.text===text)) return;
  try {
    const { data, error } = await db.from('skz_tasks').insert({ event_id: eid, text, done: false }).select().single();
    if (error) throw error;
    ev.tasks.push({ id: data.id, text: data.text, done: data.done });
    renderList(); renderCalendar();
  } catch(e) { console.error(e); showToast('è¿½åŠ ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢','error'); }
}

async function addFreeTask(eid, input) {
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  const ev = events.find(e=>e.id===eid);
  if (!ev) return;
  try {
    const { data, error } = await db.from('skz_tasks').insert({ event_id: eid, text, done: false }).select().single();
    if (error) throw error;
    ev.tasks.push({ id: data.id, text: data.text, done: data.done });
    input.value = '';
    renderList(); renderCalendar();
  } catch(e) { console.error(e); showToast('è¿½åŠ ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢','error'); }
}

function deadlineBadge(endDate) {
  const today = new Date(); today.setHours(0,0,0,0);
  const end = new Date(endDate); end.setHours(0,0,0,0);
  const diff = Math.ceil((end-today)/86400000);
  if (diff<0) return `<span class="deadline-red">è²©å£²çµ‚äº†</span>`;
  if (diff<=3) return `<span class="deadline-red">âš  æœŸé™ã‚ã¨${diff}æ—¥ï¼</span>`;
  if (diff<=7) return `<span class="deadline-warn">æœŸé™ã‚ã¨${diff}æ—¥</span>`;
  return `<span style="font-size:10px;color:var(--gray-mid)">ã€œ${end.getMonth()+1}/${end.getDate()}ã¾ã§</span>`;
}

function emptyState(msg) {
  const el = document.createElement('div');
  el.className = 'empty-state';
  el.innerHTML = `<div class="e-emoji">ğŸ©·</div><p>${msg}</p>`;
  return el;
}

// ===== MODAL =====
let selCatVal = null;
let editingId = null;

function openModal() {
  editingId = null;
  document.getElementById('f-edit-id').value = '';
  document.getElementById('modal-title').textContent = 'ğŸ§­ ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ';
  document.getElementById('btn-save-label').textContent = 'ä¿å­˜ã™ã‚‹';
  document.getElementById('overlay').classList.add('open');
  document.getElementById('f-start').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-name').focus();
}

function openEditModal(eid) {
  const ev = events.find(e=>e.id===eid);
  if (!ev) return;
  editingId = eid;
  document.getElementById('f-edit-id').value = eid;
  document.getElementById('modal-title').textContent = 'âœï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†';
  document.getElementById('btn-save-label').textContent = 'æ›´æ–°ã™ã‚‹';

  document.getElementById('f-name').value = ev.name;
  document.getElementById('f-start').value = ev.start.toISOString().split('T')[0];
  document.getElementById('f-end').value = ev.end ? ev.end.toISOString().split('T')[0] : '';
  document.getElementById('f-time').value = ev.time || '';
  document.getElementById('f-place').value = ev.place || '';
  document.getElementById('f-memo').value = ev.memo || '';
  selCatVal = ev.cat;
  document.querySelectorAll('.cat-opt').forEach(el=>el.classList.toggle('sel', el.dataset.cat===ev.cat));

  document.getElementById('overlay').classList.add('open');
}

function deleteEvent(eid) {
  const ev = events.find(e=>e.id===eid);
  if (!ev) return;
  document.getElementById('confirm-name').textContent = ev.name;
  document.getElementById('confirm-overlay').dataset.eid = eid;
  document.getElementById('confirm-overlay').classList.add('open');
}
async function confirmDelete() {
  const eid = document.getElementById('confirm-overlay').dataset.eid;
  try {
    // ã‚¿ã‚¹ã‚¯ã¯on delete cascadeã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹
    const { error } = await db.from('skz_events').delete().eq('id', eid);
    if (error) throw error;
    if (activeEventId===eid) activeEventId = null;
    closeConfirm();
    showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸã‚ˆğŸ—‘');
    await loadData();
  } catch(e) {
    console.error(e);
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢', 'error');
  }
}
function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('open');
}
function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  selCatVal = null;
  editingId = null;
  document.querySelectorAll('.cat-opt').forEach(el=>el.classList.remove('sel'));
  ['f-name','f-end','f-time','f-place','f-memo'].forEach(id=>document.getElementById(id).value='');
}
function closeBg(e) { if(e.target.id==='overlay') closeModal(); }
function selCat(cat) {
  selCatVal = cat;
  document.querySelectorAll('.cat-opt').forEach(el=>el.classList.toggle('sel',el.dataset.cat===cat));
}
async function saveEvent() {
  const name = document.getElementById('f-name').value.trim();
  const startVal = document.getElementById('f-start').value;
  if (!name || !startVal || !selCatVal) { showToast('ã‚¤ãƒ™ãƒ³ãƒˆåãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»é–‹å§‹æ—¥ã¯å¿…é ˆã ã‚ˆï¼', 'error'); return; }
  const endVal = document.getElementById('f-end').value;
  const data = {
    name, cat: selCatVal,
    start_date: startVal,
    end_date: endVal || null,
    time: document.getElementById('f-time').value || null,
    place: document.getElementById('f-place').value.trim() || null,
    memo: document.getElementById('f-memo').value.trim() || null,
  };

  try {
    if (editingId !== null) {
      const { error } = await db.from('skz_events').update(data).eq('id', editingId);
      if (error) throw error;
      showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°ã—ãŸã‚ˆâœ¨');
    } else {
      const { error } = await db.from('skz_events').insert(data);
      if (error) throw error;
      showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸã‚ˆğŸ‰');
    }
    closeModal();
    await loadData();
  } catch(e) {
    console.error(e);
    showToast('ä¿å­˜ã«å¤±æ•—ã—ãŸã‚ˆğŸ˜¢', 'error');
  }
}

// ===== ã‚¹ãƒãƒ›ã‚¿ãƒ–åˆ‡æ›¿ =====
function switchTab(tab) {
  const main = document.getElementById('main-grid');
  main.className = `main show-${tab}`;
  document.getElementById('tab-cal').classList.toggle('active', tab==='cal');
  document.getElementById('tab-list').classList.toggle('active', tab==='list');
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  loadData();

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  document.getElementById('btn-add-event').addEventListener('click', openModal);

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“
  document.getElementById('btn-prev-month').addEventListener('click', () => changeMonth(-1));
  document.getElementById('btn-next-month').addEventListener('click', () => changeMonth(1));
  document.getElementById('btn-today').addEventListener('click', goToday);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('overlay').addEventListener('click', e => { if(e.target.id==='overlay') closeModal(); });
  document.getElementById('btn-modal-cancel').addEventListener('click', closeModal);
  document.getElementById('btn-save-label').addEventListener('click', saveEvent);

  // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('confirm-overlay').addEventListener('click', e => { if(e.target.id==='confirm-overlay') closeConfirm(); });
  document.getElementById('btn-confirm-cancel').addEventListener('click', closeConfirm);
  document.getElementById('btn-confirm-delete').addEventListener('click', confirmDelete);

  // ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆå§”ä»»ï¼‰
  document.querySelector('.cat-grid').addEventListener('click', e => {
    const opt = e.target.closest('.cat-opt');
    if (opt) selCat(opt.dataset.cat);
  });
});

</script>
</body>
</html>
